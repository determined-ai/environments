{
  "variables": {
    "aws_access_key_id": "{{ env `AWS_ACCESS_KEY_ID` }}",
    "aws_secret_access_key": "{{ env `AWS_SECRET_ACCESS_KEY` }}",
    "aws_base_image": "ami-077ee47512dc6f3ca",
    "gov_aws_access_key_id": "{{ env `GOV_AWS_ACCESS_KEY_ID` }}",
    "gov_aws_secret_access_key": "{{ env `GOV_AWS_SECRET_ACCESS_KEY` }}",
    "gov_aws_base_image": "ami-029a634618d6c0300",
    "gcp_base_image": "ubuntu-2004-focal-v20220118",
    "image_description": "Determined environments",
    "cpu_tf2_environment_name": "{{ env `CPU_TF2_ENVIRONMENT_NAME` }}",
    "gpu_tf2_environment_name": "{{ env `GPU_TF2_ENVIRONMENT_NAME` }}",
    "short_git_hash": "{{ env `short_git_hash` }}",
    "image_suffix": "",
    "docker_registry": "{{ env `DOCKERHUB_REGISTRY` }}"
  },
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done"
      ]
    },
    {
      "type": "ansible",
      "playbook_file": "environments-playbook.yml",
      "extra_arguments": [
        "--verbose",
        "-e ansible_python_interpreter=/usr/bin/python3",
        "-e linux_kernel_suffix=aws",
        "-e build_type={{ build_type }}",
        "-e cpu_tf2_environment_name={{ user `docker_registry` }}/{{ user `cpu_tf2_environment_name` }}",
        "-e gpu_tf2_environment_name={{ user `docker_registry` }}/{{ user `gpu_tf2_environment_name` }}",
        "-e short_git_hash={{ user `short_git_hash` }}",
        "-e image_suffix={{ user `image_suffix` }}"
      ],
      "user": "ubuntu",
      "only": [
        "amazon-ebs",
        "amazon-ebs-gov"
      ]
    },
    {
      "type": "ansible",
      "playbook_file": "environments-playbook.yml",
      "extra_arguments": [
        "--verbose",
        "-e ansible_python_interpreter=/usr/bin/python3",
        "-e linux_kernel_suffix=gcp",
        "-e build_type={{ build_type }}",
        "-e cpu_tf2_environment_name={{ user `docker_registry` }}/{{ user `cpu_tf2_environment_name` }}",
        "-e gpu_tf2_environment_name={{ user `docker_registry` }}/{{ user `gpu_tf2_environment_name` }}",
        "-e short_git_hash={{ user `short_git_hash` }}",
        "-e image_suffix={{ user `image_suffix` }}"
      ],
      "user": "ubuntu",
      "only": [
        "det-environments{{ user `image_suffix` }}"
      ]
    },
    {
      "type": "shell",
      "expect_disconnect": true,
      "inline": [
        "sudo reboot"
      ]
    }
  ],
  "builders": [
    {
      "type": "googlecompute",
      "name": "det-environments{{ user `image_suffix` }}",
      "project_id": "determined-ai",
      "source_image": "{{ user `gcp_base_image`}}",
      "ssh_username": "packer",
      "zone": "us-west1-b",
      "disk_size": 100,
      "on_host_maintenance": "TERMINATE",
      "machine_type": "n1-standard-1",
      "accelerator_type": "zones/us-west1-b/acceleratorTypes/nvidia-tesla-k80",
      "accelerator_count": 1,
      "state_timeout": "10m",
      "image_name": "det-environments{{ user `image_suffix` }}",
      "image_description": "{{ user `image_description` }}"
    }
  ],
  "post-processors": [
    {
      "type": "shell-local",
      "scripts": [
        "./post-process.sh"
      ]
    }
  ]
}
